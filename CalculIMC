import tkinter as tk
from tkinter import ttk, messagebox, filedialog
import csv
from datetime import datetime
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import webbrowser


class AdvancedIMCCalculator:
    def __init__(self, root):
        self.root = root
        self.root.title("ðŸš€ Calculateur d'IMC Premium")
        self.root.geometry("800x600")
        self.setup_ui()
        self.history_file = "historique_imc_advanced.csv"
        self.setup_history_file()

    def setup_ui(self):
        # Style
        style = ttk.Style()
        style.configure('TFrame', background='#f0f0f0')
        style.configure('TLabel', background='#f0f0f0', font=('Helvetica', 10))
        style.configure('TButton', font=('Helvetica', 10))

        # Main Frame
        main_frame = ttk.Frame(self.root, padding="10")
        main_frame.pack(fill=tk.BOTH, expand=True)

        # Input Frame
        input_frame = ttk.Frame(main_frame)
        input_frame.pack(pady=10, fill=tk.X)

        ttk.Label(input_frame, text="Poids (kg):").grid(row=0, column=0, padx=5, pady=5, sticky=tk.W)
        self.weight_entry = ttk.Entry(input_frame)
        self.weight_entry.grid(row=0, column=1, padx=5, pady=5)

        ttk.Label(input_frame, text="Taille (m):").grid(row=1, column=0, padx=5, pady=5, sticky=tk.W)
        self.height_entry = ttk.Entry(input_frame)
        self.height_entry.grid(row=1, column=1, padx=5, pady=5)

        # Button Frame
        button_frame = ttk.Frame(main_frame)
        button_frame.pack(pady=10)

        ttk.Button(button_frame, text="Calculer IMC", command=self.calculate_imc).grid(row=0, column=0, padx=5)
        ttk.Button(button_frame, text="Afficher Historique", command=self.show_history).grid(row=0, column=1, padx=5)
        ttk.Button(button_frame, text="Graphique d'Ã‰volution",
                   command=self.show_trend_chart).grid(row=0, column=2, padx=5)
        ttk.Button(button_frame, text="Conseils SantÃ©", command=self.show_health_tips).grid(row=0, column=3, padx=5)
        ttk.Button(button_frame, text="Exporter DonnÃ©es", command=self.export_data).grid(row=0, column=4, padx=5)

        # Results Frame
        results_frame = ttk.Frame(main_frame)
        results_frame.pack(pady=10, fill=tk.BOTH, expand=True)

        self.result_text = tk.Text(results_frame, height=10, wrap=tk.WORD)
        self.result_text.pack(fill=tk.BOTH, expand=True)

        # Chart Frame
        self.chart_frame = ttk.Frame(main_frame)
        self.figure, self.ax = plt.subplots(figsize=(6, 3))
        self.canvas = FigureCanvasTkAgg(self.figure, master=self.chart_frame)
        self.canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)

    def setup_history_file(self):
        try:
            with open(self.history_file, 'x', newline='') as file:
                writer = csv.writer(file)
                writer.writerow(["Date", "Poids (kg)", "Taille (m)", "IMC", "CatÃ©gorie", "Notes"])
        except FileExistsError:
            pass

    def calculate_imc(self):
        try:
            weight = float(self.weight_entry.get())
            height = float(self.height_entry.get())

            if weight <= 0 or height <= 0:
                messagebox.showerror("Erreur", "Les valeurs doivent Ãªtre positives !")
                return

            imc = weight / (height ** 2)
            category = self.classify_imc(imc)
            bmi_scale = self.get_bmi_scale_position(imc)

            result = (
                f"ðŸ“Š RÃ©sultats IMC :\n"
                f"â€¢ Poids: {weight} kg\n"
                f"â€¢ Taille: {height} m\n"
                f"â€¢ IMC: {imc:.1f}\n"
                f"â€¢ CatÃ©gorie: {category}\n"
                f"â€¢ Ã‰chelle: [{bmi_scale}]\n\n"
                f"{self.get_health_advice(category)}"
            )

            self.result_text.delete(1.0, tk.END)
            self.result_text.insert(tk.END, result)

            # Save to history
            self.save_to_history(weight, height, imc, category)

        except ValueError:
            messagebox.showerror("Erreur", "Entrez des nombres valides !")

    def classify_imc(self, imc):
        if imc < 16.5:
            return "DÃ©nutrition"
        elif 16.5 <= imc < 18.5:
            return "Maigreur"
        elif 18.5 <= imc < 25:
            return "Poids normal"
        elif 25 <= imc < 30:
            return "Surpoids"
        elif 30 <= imc < 35:
            return "ObÃ©sitÃ© modÃ©rÃ©e"
        elif 35 <= imc < 40:
            return "ObÃ©sitÃ© sÃ©vÃ¨re"
        else:
            return "ObÃ©sitÃ© morbide"

    def get_bmi_scale_position(self, imc):
        scale = ["16.5", "18.5", "25", "30", "35", "40"]
        markers = ["D", "M", "N", "S", "O1", "O2", "O3"]

        position = []
        for i, threshold in enumerate([16.5, 18.5, 25, 30, 35, 40]):
            if imc < threshold:
                position = markers[i]
                break
        else:
            position = markers[-1]

        scale_str = "|".join(scale)
        return f"{scale_str} â† Vous Ãªtes ici ({position})"

    def get_health_advice(self, category):
        advice = {
            "DÃ©nutrition": "âš ï¸ Consultation mÃ©dicale urgente recommandÃ©e",
            "Maigreur": "ðŸ’¡ Consultez un nutritionniste pour un rÃ©gime adaptÃ©",
            "Poids normal": "âœ… Maintenez vos bonnes habitudes alimentaires",
            "Surpoids": "ðŸƒ Augmentez votre activitÃ© physique progressivement",
            "ObÃ©sitÃ© modÃ©rÃ©e": "ðŸ‘¨â€âš•ï¸ Consultation mÃ©dicale recommandÃ©e",
            "ObÃ©sitÃ© sÃ©vÃ¨re": "ðŸ¥ Programme de suivi mÃ©dical nÃ©cessaire",
            "ObÃ©sitÃ© morbide": "ðŸ†˜ Prise en charge mÃ©dicale urgente requise"
        }
        return f"ðŸ’¡ Conseil santÃ© :\n{advice.get(category, '')}"

    def save_to_history(self, weight, height, imc, category):
        note = simpledialog.askstring("Notes", "Ajoutez des notes (optionnel):")
        with open(self.history_file, 'a', newline='') as file:
            writer = csv.writer(file)
            writer.writerow([
                datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                weight,
                height,
                f"{imc:.1f}",
                category,
                note or ""
            ])

    def show_history(self):
        try:
            with open(self.history_file, 'r') as file:
                reader = csv.reader(file)
                history = list(reader)

                if len(history) <= 1:
                    messagebox.showinfo("Historique", "Aucun historique disponible")
                    return

                # Create a new window for history display
                history_window = tk.Toplevel(self.root)
                history_window.title("Historique Complet")

                # Treeview widget
                tree = ttk.Treeview(history_window)
                tree["columns"] = history[0]
                tree["show"] = "headings"

                for col in history[0]:
                    tree.heading(col, text=col)
                    tree.column(col, width=100)

                for row in history[1:]:
                    tree.insert("", tk.END, values=row)

                tree.pack(expand=True, fill=tk.BOTH)

        except FileNotFoundError:
            messagebox.showerror("Erreur", "Fichier d'historique introuvable")

    def show_trend_chart(self):
        try:
            dates = []
            bmis = []

            with open(self.history_file, 'r') as file:
                reader = csv.DictReader(file)
                for row in reader:
                    dates.append(datetime.strptime(row['Date'], "%Y-%m-%d %H:%M:%S"))
                    bmis.append(float(row['IMC']))

            if len(dates) < 2:
                messagebox.showinfo("Info", "Pas assez de donnÃ©es pour un graphique")
                return

            self.ax.clear()
            self.ax.plot(dates, bmis, marker='o', linestyle='-')
            self.ax.set_title("Ã‰volution de votre IMC")
            self.ax.set_ylabel("IMC")
            self.ax.grid(True)
            self.figure.autofmt_xdate()

            # Add healthy range
            self.ax.axhspan(18.5, 25, color='green', alpha=0.1)
            self.ax.axhline(18.5, color='green', linestyle='--', alpha=0.5)
            self.ax.axhline(25, color='green', linestyle='--', alpha=0.5)

            self.chart_frame.pack(fill=tk.BOTH, expand=True)
            self.canvas.draw()

        except Exception as e:
            messagebox.showerror("Erreur", f"Erreur lors de la crÃ©ation du graphique : {str(e)}")

    def show_health_tips(self):
        tips_window = tk.Toplevel(self.root)
        tips_window.title("Conseils SantÃ© par CatÃ©gorie IMC")

        tips = {
            "DÃ©nutrition": [
                "- Consultation mÃ©dicale urgente",
                "- RÃ©gime hypercalorique sous supervision",
                "- SupplÃ©mentation nutritionnelle"
            ],
            "Maigreur": [
                "- Augmentation progressive des apports caloriques",
                "- ActivitÃ© physique modÃ©rÃ©e pour dÃ©velopper la masse musculaire",
                "- Ã‰viter les rÃ©gimes restrictifs"
            ],
            "Poids normal": [
                "- Maintenir une alimentation Ã©quilibrÃ©e",
                "- 150 minutes d'activitÃ© physique modÃ©rÃ©e par semaine",
                "- Surveillance annuelle de l'IMC"
            ],
            "Surpoids": [
                "- RÃ©duction modÃ©rÃ©e des apports caloriques",
                "- 300 minutes d'activitÃ© physique par semaine",
                "- Limitation des graisses saturÃ©es et sucres simples"
            ],
            "ObÃ©sitÃ© modÃ©rÃ©e": [
                "- Programme de perte de poids supervisÃ©",
                "- Prise en charge multidisciplinaire",
                "- ActivitÃ© physique adaptÃ©e"
            ],
            "ObÃ©sitÃ© sÃ©vÃ¨re": [
                "- Consultation endocrinologique",
                "- Ã‰valuation des comorbiditÃ©s",
                "- Programme intensif de modification du mode de vie"
            ],
            "ObÃ©sitÃ© morbide": [
                "- Prise en charge mÃ©dicale urgente",
                "- Ã‰valuation pour chirurgie bariatrique",
                "- Suivi psychologique"
            ]
        }

        notebook = ttk.Notebook(tips_window)

        for category, advice_list in tips.items():
            frame = ttk.Frame(notebook)
            text = tk.Text(frame, wrap=tk.WORD)
            text.pack(fill=tk.BOTH, expand=True)

            for advice in advice_list:
                text.insert(tk.END, f"â€¢ {advice}\n")

            text.config(state=tk.DISABLED)
            notebook.add(frame, text=category)

        notebook.pack(fill=tk.BOTH, expand=True)

    def export_data(self):
        file_path = filedialog.asksaveasfilename(
            defaultextension=".csv",
            filetypes=[("Fichiers CSV", "*.csv"), ("Tous les fichiers", "*.*")],
            title="Exporter les donnÃ©es"
        )

        if file_path:
            try:
                with open(self.history_file, 'r') as source, open(file_path, 'w') as target:
                    target.write(source.read())
                messagebox.showinfo("SuccÃ¨s", f"DonnÃ©es exportÃ©es vers {file_path}")
            except Exception as e:
                messagebox.showerror("Erreur", f"Ã‰chec de l'export : {str(e)}")


if __name__ == "__main__":
    root = tk.Tk()
    app = AdvancedIMCCalculator(root)
    root.mainloop()
